---
title: "保持进程后台运行的实现方式"
date: "2025-12-30 10:54:55"
author: shouw
categories:
  - 编程
email: KijinSeija@shouw.blog
readmore: true
tags:
  - 技术
  - 网络
  - Linux
  - 技巧
---

# 保持进程后台运行的实现方式

在 Linux 服务器上进行开发或运维时，我们经常面临一个问题：当你通过 SSH 远程连接服务器并运行一个耗时较长的任务（比如编译大型项目、训练深度学习模型、传输大文件）时，如果网络波动导致 SSH 断开，或者你不得不关闭电脑，终端会话结束，随之而来的就是正在运行的进程被系统发送的 `SIGHUP` 信号无情杀掉。

为了解决这个问题，我们需要让进程在“后台”持续运行，即使当前终端关闭也不受影响。本文将介绍几种主流的实现方式，并分析它们的优缺点。

## 1. 基础方案：& 号与 disown

最简单的后台运行方式是利用 Shell 的内置功能。

### 使用方法

在命令最后加上 `&` 符号，可以将命令放入后台运行：

但是，这样做仅仅是让命令在当前 Shell 的后台运行。如果 Shell 关闭，进程依然可能被杀掉。为了避免这种情况，需要配合 disown 命令：

如果你已经运行了一个前台程序，可以按 Ctrl+Z 暂停它，然后：

### 利弊分析

* ​**优点**​：无需安装任何额外软件，所有 Linux 发行版通用，操作极快。
* ​**缺点**​：
  
  * ​**无法重新连接**​：一旦关闭终端，你再也看不到程序的标准输出（stdout），无法与程序交互。
  * ​**管理困难**​：只能通过 ps 或 kill 来管理进程，容易遗忘。

---

## 2. 经典方案：nohup

nohup (No Hang Up) 是最经典的解决方案，它的唯一用途就是让命令忽略挂起信号（SIGHUP）。

### 使用方法

* nohup：忽略挂起信号。
* > ：重定向标准输出。
* 2>&1：将标准错误重定向到标准输出。
* &：放入后台运行。

如果不指定重定向文件，nohup 会默认将输出写入当前目录下的 nohup.out。

### 利弊分析

* ​**优点**​：系统自带，简单稳定，自动保留日志文件。
* ​**缺点**​：
  
  * ​**无法交互**​：和 & 一样，程序一旦运行就没法再“回到”那个界面输入指令了（比如程序中途需要输入 'yes' 确认）。
  * ​**日志膨胀**​：如果程序输出量极大，nohup.out 会迅速占用磁盘空间。

---

## 3. 进阶方案：Tmux / Screen (推荐)

这是目前开发者最爱使用的方案。Tmux 和 Screen 属于​**终端复用器 (Terminal Multiplexer)**​。它们允许你在一个 SSH 会话中创建多个“虚拟终端”，并且这些虚拟终端可以与当前 SSH 会话​**分离 (Detach)**​，在后台保持运行，稍后还可以**重新连接 (Attach)** 回去。

这里主要推荐 Tmux。

### 使用方法

* **安装 Tmux** (如果未安装)：
* ​**创建新会话**​：
* ​**在 Tmux 中运行任务**​：
  正常执行你的命令，比如 python train.py。
* ​**分离会话** (Detach)​：
  按下快捷键 Ctrl + B，松开后按 d。
  此时你会回到原本的 Shell，但任务依然在后台那个“平行宇宙”里跑着。
* **重新连接** (Attach)​：
  回家连上 VPN 后，想看看跑得怎么样了：

### 利弊分析

* ​**优点**​：
  
  * ​**上下文保留**​：不仅进程在跑，连终端里的历史输出、环境变量、当前目录都完好无损。
  * ​**可交互**​：随时回去查看进度，如果程序报错或者需要输入，可以直接操作。
  * ​**多窗口**​：一个 Tmux 会话里可以开多个窗口，分屏操作，极其高效。
* ​**缺点**​：
  
  * 需要额外安装软件。
  * 有快捷键的学习成本（虽然只需要记住几个核心的就行）。

---

## 4. 生产级方案：Systemd

如果你是在部署一个长期运行的服务（比如 Web 服务器、数据库、监控脚本），而不是临时的跑个脚本，那么 Systemd 才是正道。它是 Linux 的系统和服务管理器。

### 使用方法

创建一个服务文件 /etc/systemd/system/myapp.service：

然后启动并设置开机自启：

### 利弊分析

* ​**优点**​：
  
  * ​**自动重启**​：程序崩了会自动拉起来（Restart=always）。
  * ​**开机自启**​：服务器重启后服务会自动运行。
  * ​**日志管理**​：通过 journalctl 统一管理日志。
  * ​**标准化**​：这是 Linux 运维的标准操作。
* ​**缺点**​：
  
  * 配置相对繁琐，不适合“跑一次就扔”的临时任务。
  * 需要 Root 权限来配置服务。

---

## 5. 补充：如何监控它们？(Top/Htop)

你在题目中提到了 top，其实 top 并不是用来“保持”进程运行的，而是用来**监控**正在运行的进程的。

不管你用上面哪种方式（nohup, tmux, systemd）启动了后台进程，你都可以通过以下方式找到它们：

* ​**top / htop**​：
  实时查看 CPU 和 内存占用。如果你的后台任务很吃资源，一打开 top 就能在最上面看到它。
* ​**ps 命令**​：
  
  精准查找特定的进程 PID。

## 总结

* ​**临时跑个小脚本**​：用 nohup command &，简单粗暴。
* ​**开发调试、耗时任务、需要看进度**​：推荐 ​**Tmux**​。这是是真的很好用。
* ​**生产环境部署服务**​：写 **Systemd** 配置文件，保证服务的高可用。